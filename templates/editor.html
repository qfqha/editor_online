<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>编辑 - {{ file.name }} - 多人协作编辑平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        /* 保持原有样式不变 */
        /* 基础样式 */
        body {
            background-color: #f5f7fa;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .card {
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: box-shadow 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .editor-container {
            min-height: 60vh;
        }
        
        .editor-toolbar {
            border-bottom: 1px solid #e9ecef;
            padding: 10px 0;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* 同步状态提示 */
        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 4px;
            color: white;
            z-index: 1000;
            display: none;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        .sync-status.success {
            background-color: #28a745;
            display: block;
        }
        
        .sync-status.error {
            background-color: #dc3545;
            display: block;
        }
        
        .sync-status.warning {
            background-color: #ffc107;
            color: #333;
            display: block;
        }
        
        /* 其他样式保持不变 */
        #word-editor {
            width: 100%;
            min-height: 500px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 20px;
            resize: vertical;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            font-size: 16px;
            line-height: 1.6;
            background-color: white;
            transition: border-color 0.2s;
        }
        
        #word-editor:focus {
            border-color: #80bdff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        
        .editors-panel {
            background-color: white;
            border-radius: 6px;
            padding: 15px;
            border: 1px solid #e9ecef;
        }
        
        .editors-panel .card-title {
            color: #495057;
            font-size: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 15px;
        }
        
        .sync-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .sync-pending {
            background-color: #ffc107;
            animation: pulse 1.5s infinite;
        }
        
        .sync-complete {
            background-color: #28a745;
        }
        
        .sync-error {
            background-color: #dc3545;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .excel-scroll-container {
            overflow-x: auto;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
        }
        
        .excel-cell {
            transition: background-color 0.2s, box-shadow 0.2s;
            border: 1px solid #ced4da;
            width: 100%;
            min-height: 30px;
        }
        
        .excel-cell:focus {
            background-color: #e6f7ff;
            border-color: #80bdff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
            z-index: 2;
        }
        
        .selected-row {
            background-color: #f0f7ff !important;
        }
        
        .selected-col {
            background-color: #f0f7ff !important;
        }
        
        .excel-header-cell {
            position: relative;
            user-select: none;
            background-color: #f8f9fa;
            font-weight: 600;
            text-align: center;
            padding: 5px;
            min-width: 120px;
        }
        
        .excel-header-cell:hover {
            background-color: #e9ecef;
            cursor: pointer;
        }
        
        .excel-header-input {
            width: 100%;
            background: transparent;
            border: 1px solid transparent;
            text-align: center;
            font-weight: 600;
            padding: 3px;
            min-width: 80px;
        }
        
        .excel-header-input:focus {
            background-color: white;
            border-color: #80bdff;
            border-radius: 3px;
            outline: none;
        }
        
        .excel-row-number {
            background-color: #f8f9fa;
            text-align: center;
            font-weight: 600;
            user-select: none;
            min-width: 50px;
            padding: 5px;
            position: sticky;
            left: 0;
            z-index: 2;
            background-color: #f8f9fa;
        }
        
        .excel-row-number:hover {
            background-color: #e9ecef;
            cursor: pointer;
        }
        
        #excel-editor {
            border-collapse: separate;
            border-spacing: 0;
            table-layout: auto;
            min-width: 100%;
        }
        
        #excel-editor th, #excel-editor td {
            border: 1px solid #e9ecef;
            padding: 0;
            overflow: hidden;
        }
        
        #excel-editor th:first-child {
            border-right: 2px solid #dee2e6;
        }
        
        #excel-editor thead tr:first-child th {
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 2;
            background-color: #f8f9fa;
        }
        
        .column-resizer {
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
            cursor: col-resize;
            background-color: transparent;
            z-index: 10;
        }
        
        .column-resizer:hover {
            background-color: #0d6efd;
        }
        
        .row-resizer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 5px;
            cursor: row-resize;
            background-color: transparent;
            z-index: 10;
        }
        
        .row-resizer:hover {
            background-color: #0d6efd;
        }
        
        .resizing {
            user-select: none;
            -webkit-user-select: none;
        }
        
        .structure-actions {
            margin-bottom: 15px;
            padding: 15px;
            background-color: white;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        
        .structure-actions h5 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #495057;
        }
        
        .btn-sm {
            padding: 4px 10px;
            font-size: 13px;
        }
        
        .btn-outline-primary {
            color: #0d6efd;
            border-color: #0d6efd;
        }
        
        .btn-outline-primary:hover {
            background-color: #0d6efd;
            color: white;
        }
        
        .btn-outline-danger {
            color: #dc3545;
            border-color: #dc3545;
        }
        
        .btn-outline-danger:hover {
            background-color: #dc3545;
            color: white;
        }
        
        #edit-position {
            font-family: monospace;
        }
        
        #activity-log {
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.9em;
            border-top: 1px solid #e9ecef;
            padding-top: 10px;
        }
        
        #online-users-list .d-flex, #editors-list .d-flex {
            padding: 5px 0;
            border-bottom: 1px solid #f1f3f5;
        }
        
        @media (max-width: 768px) {
            .row {
                flex-direction: column;
            }
            
            .col-md-9, .col-md-3 {
                width: 100%;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- 同步状态提示框 -->
    <div id="sync-toast" class="sync-status">操作已完成</div>

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-journal-text me-2"></i>多人协作编辑平台
            </a>
            <div class="ms-auto">
                <span class="navbar-text me-3">
                    <i class="bi bi-person-circle me-1"></i>{{ username }}
                </span>
                <button class="btn btn-outline-light me-2" id="download-btn">
                    <i class="bi bi-download me-1"></i>下载文件
                </button>
                <a href="/files" class="btn btn-outline-light">
                    <i class="bi bi-arrow-left me-1"></i>返回文件列表
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row mb-3">
            <div class="col">
                <h3>
                    {% if file.type == 'word' %}
                    <i class="bi bi-file-word text-primary me-2"></i>
                    {% elif file.type == 'excel' %}
                    <i class="bi bi-file-excel text-success me-2"></i>
                    {% endif %}
                    {{ file.name }}
                </h3>
                <p class="text-muted">正在多人协作编辑中... 所有更改会自动保存和同步</p>
            </div>
        </div>

        <div class="row">
            <!-- 主编辑区域 -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-body">
                        <div class="editor-toolbar">
                            <div class="text-success" id="status-indicator">
                                <span class="sync-indicator sync-complete"></span>
                                <span>已同步</span>
                            </div>
                        </div>

                        <!-- Excel专用操作按钮 -->
                        {% if file.type == 'excel' %}
                        <div class="structure-actions">
                            <h5 class="mb-3">表格操作</h5>
                            <div class="btn-group me-2">
                                <button class="btn btn-sm btn-outline-primary" id="add-row-btn">
                                    <i class="bi bi-plus-circle me-1"></i>添加行
                                </button>
                                <button class="btn btn-sm btn-outline-danger" id="delete-row-btn" disabled>
                                    <i class="bi bi-trash me-1"></i>删除行
                                </button>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary" id="add-col-btn">
                                    <i class="bi bi-plus-circle me-1"></i>添加列
                                </button>
                                <button class="btn btn-sm btn-outline-danger" id="delete-col-btn" disabled>
                                    <i class="bi bi-trash me-1"></i>删除列
                                </button>
                            </div>
                            <div class="text-muted ms-3">
                                提示：先点击行号或列标题选择要操作的行列，双击列标题可修改列名
                            </div>
                        </div>
                        {% endif %}

                        <!-- Word专用工具栏 -->
                        {% if file.type == 'word' %}
                        <div class="structure-actions">
                            <h5 class="mb-3">文档操作</h5>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary" id="add-paragraph-btn">
                                    <i class="bi bi-plus-circle me-1"></i>添加段落
                                </button>
                            </div>
                        </div>
                        {% endif %}

                        <div class="editor-container">
                            {% if file.type == 'word' %}
                            <!-- Word编辑器 -->
                            <textarea id="word-editor"></textarea>
                            
                            {% elif file.type == 'excel' %}
                            <!-- Excel编辑器 -->
                            <div class="excel-scroll-container">
                                <table class="table table-bordered" id="excel-editor">
                                    <thead>
                                        <tr>
                                            <th class="excel-row-number">#</th>
                                            <!-- 列标题将通过JavaScript动态填充 -->
                                        </tr>
                                    </thead>
                                    <tbody id="excel-body"></tbody>
                                </table>
                            </div>
                            {% endif %}
                        </div>

                        <div class="mt-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="bi bi-map-pin me-1"></i>当前编辑位置
                                        </span>
                                        <input type="text" class="form-control" id="edit-position" 
                                               placeholder="例如: 段落3 或 A1单元格">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧编辑者面板 -->
            <div class="col-md-3">
                <div class="card editors-panel h-100">
                    <h5 class="card-title mb-3">
                        <i class="bi bi-people me-2"></i>当前编辑者
                    </h5>
                    <div id="editors-list">
                        <!-- 编辑者列表将通过JavaScript动态填充 -->
                    </div>
                    
                    <div class="mt-4">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-info-circle me-2"></i>在线用户
                        </h5>
                        <div id="online-users-list">
                            <!-- 在线用户列表将通过JavaScript动态填充 -->
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-clock-history me-2"></i>操作日志
                        </h5>
                        <div id="activity-log" style="max-height: 200px; overflow-y: auto; font-size: 0.9em;">
                            <div class="text-muted">操作记录将显示在这里...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        // 当前文件信息
        const fileId = '{{ file.id }}';
        const fileType = '{{ file.type }}';
        const username = '{{ username }}';
        
        // 全局变量
        let socket;
        let editorElement;
        let currentContent = '';
        let isSyncing = false;
        let excelData = null;  // 存储Excel数据的全局变量
        let wordData = null;   // 存储Word数据的全局变量
        let selectedRow = -1;
        let selectedCol = -1;
        let columnWidths = {};  // 存储列宽
        let rowHeights = {};    // 存储行高
        let isRenamingColumn = false; // 标记是否正在重命名列
        let pendingSyncs = 0;   // 跟踪待同步操作数量
        let lastOperationId = null; // 跟踪操作ID用于去重
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 创建同步提示框
            const toast = document.getElementById('sync-toast');
            
            // 初始化Socket连接
            initSocket();
            
            // 根据文件类型初始化编辑器
            if (fileType === 'word') {
                initWordEditor();
                initWordEventListeners();
            } else if (fileType === 'excel') {
                initExcelEditor();
                initExcelEventListeners();
                initResizeHandlers();
            }
            
            // 加入编辑房间
            socket.emit('join_editor', fileId);
            
            // 加载在线用户
            loadOnlineUsers();
            
            // 设置定时刷新在线用户
            setInterval(loadOnlineUsers, 5000);
            
            // 为下载按钮添加事件监听 - 完全重构下载逻辑
            document.getElementById('download-btn').addEventListener('click', function() {
                if (isSyncing || pendingSyncs > 0) {
                    showToast('正在等待所有更改同步完成，请稍后...', 'warning');
                    showStatus('等待同步完成后再下载', 'warning');
                    
                    // 同步完成后自动触发下载
                    const checkSyncInterval = setInterval(() => {
                        if (!isSyncing && pendingSyncs === 0) {
                            clearInterval(checkSyncInterval);
                            triggerExcelDownload();
                        }
                    }, 500);
                } else {
                    triggerExcelDownload();
                }
            });
        });
        
        // 触发Excel下载 - 全新实现
        function triggerExcelDownload() {
            if (fileType !== 'excel' || !excelData) {
                // 非Excel文件或数据未加载，使用传统下载方式
                window.location.href = `/download/${fileId}`;
                return;
            }
            
            // 对于Excel文件，先验证数据完整性
            try {
                // 确保数据结构正确
                validateExcelData(excelData);
                
                showStatus('正在准备下载文件...', 'pending');
                
                // 创建表单数据，包含当前最新的完整数据
                const formData = new FormData();
                formData.append('file_id', fileId);
                formData.append('content', JSON.stringify(excelData));
                formData.append('filename', '{{ file.name }}');
                
                // 使用POST请求发送最新数据到服务器生成文件
                fetch('/generate-excel-download', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }
                    return response.blob();
                })
                .then(blob => {
                    // 创建下载链接
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = '{{ file.name }}';
                    document.body.appendChild(a);
                    a.click();
                    
                    // 清理
                    setTimeout(() => {
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    }, 0);
                    
                    showStatus('文件下载已准备就绪', 'success');
                    showToast('文件已开始下载', 'success');
                })
                .catch(error => {
                    console.error('下载失败:', error);
                    showStatus('下载失败，请重试', 'error');
                    showToast('下载失败: ' + error.message, 'error');
                    
                    // 失败时回退到传统下载方式
                    setTimeout(() => {
                        window.location.href = `/download/${fileId}`;
                    }, 1000);
                });
                
            } catch (error) {
                console.error('Excel数据验证失败:', error);
                showStatus('数据验证失败，无法下载', 'error');
                showToast('数据格式错误: ' + error.message, 'error');
                
                // 尝试修复数据后再下载
                if (excelData) {
                    try {
                        fixExcelData(excelData);
                        showStatus('已尝试修复数据，正在重试下载...', 'pending');
                        setTimeout(triggerExcelDownload, 1000);
                    } catch (fixError) {
                        console.error('数据修复失败:', fixError);
                        showStatus('数据修复失败，请联系管理员', 'error');
                    }
                }
            }
        }
        
        // 验证Excel数据结构完整性
        function validateExcelData(data) {
            if (!data || typeof data !== 'object') {
                throw new Error('无效的表格数据格式');
            }
            
            if (!Array.isArray(data.columns)) {
                throw new Error('表格列定义必须是数组');
            }
            
            if (!Array.isArray(data.data)) {
                throw new Error('表格数据必须是数组');
            }
            
            const columnCount = data.columns.length;
            
            // 检查每一行的单元格数量是否与列数匹配
            data.data.forEach((row, rowIndex) => {
                if (!Array.isArray(row)) {
                    throw new Error(`第 ${rowIndex + 1} 行不是有效的数组`);
                }
                
                if (row.length !== columnCount) {
                    throw new Error(`第 ${rowIndex + 1} 行的单元格数量(${row.length})与列数(${columnCount})不匹配`);
                }
            });
            
            return true;
        }
        
        // 尝试修复Excel数据结构
        function fixExcelData(data) {
            if (!data) {
                data = { columns: [], data: [] };
            }
            
            if (!Array.isArray(data.columns)) {
                data.columns = ['列 1', '列 2', '列 3'];
            }
            
            if (!Array.isArray(data.data)) {
                data.data = [];
            }
            
            const columnCount = data.columns.length;
            
            // 确保至少有一行数据
            if (data.data.length === 0) {
                data.data.push(Array(columnCount).fill(''));
            }
            
            // 修复每一行的单元格数量
            data.data = data.data.map(row => {
                if (!Array.isArray(row)) {
                    return Array(columnCount).fill('');
                }
                
                // 补充不足的单元格
                while (row.length < columnCount) {
                    row.push('');
                }
                
                // 截断多余的单元格
                if (row.length > columnCount) {
                    row = row.slice(0, columnCount);
                }
                
                return row;
            });
            
            // 更新当前内容
            currentContent = JSON.stringify(data);
            return data;
        }
        
        // 显示提示框
        function showToast(message, type = 'success') {
            const toast = document.getElementById('sync-toast');
            toast.textContent = message;
            toast.className = 'sync-status';
            toast.classList.add(type);
            
            // 3秒后隐藏
            setTimeout(() => {
                toast.className = 'sync-status';
            }, 3000);
        }
        
        // 初始化Socket连接
        function initSocket() {
            socket = io();
            
            // 监听Socket事件
            socket.on('current_content', function(data) {
                currentContent = data.content;
                updateEditorContent(currentContent);
                updateEditorsList(data.editors);
                logActivity('已加载文件内容');
            });
            
            // 内容更新
            socket.on('content_updated', function(data) {
                if (!isRenamingColumn) {
                    currentContent = data.content;
                    updateEditorContent(currentContent);
                    updateEditorsList(data.editors);
                    logActivity(`${data.username} 更新了内容`);
                    showStatus('已接收其他用户的更新', 'info');
                } else {
                    showStatus('有新的更新等待同步', 'warning');
                }
            });
            
            // Excel结构更新
            socket.on('excel_structure_updated', function(data) {
                if (!isRenamingColumn && fileType === 'excel') {
                    try {
                        const newData = JSON.parse(data.content);
                        validateExcelData(newData); // 验证数据有效性
                        
                        currentContent = data.content;
                        updateEditorContent(currentContent);
                        updateEditorsList(data.editors);
                        logActivity(`${data.username} ${data.action}`);
                        showStatus(`已接收表格结构更新`, 'info');
                    } catch (error) {
                        console.error('处理结构更新失败:', error);
                        showStatus('接收结构更新失败，已自动修复', 'warning');
                        logActivity(`结构更新验证失败: ${error.message}`);
                        
                        // 尝试修复数据
                        if (excelData) {
                            fixExcelData(excelData);
                            updateEditorContent(currentContent);
                        }
                    }
                }
            });
            
            // 列宽行高更新
            socket.on('excel_dimensions_updated', function(data) {
                if (!isRenamingColumn && fileType === 'excel') {
                    if (data.columnWidths) {
                        columnWidths = { ...columnWidths, ...data.columnWidths };
                    }
                    if (data.rowHeights) {
                        rowHeights = { ...rowHeights, ...data.rowHeights };
                    }
                    applyDimensions();
                    logActivity(`${data.username} 调整了${data.action}`);
                }
            });
            
            // 列名更新
            socket.on('excel_column_renamed', function(data) {
                if (fileType === 'excel') {
                    try {
                        const newData = JSON.parse(data.content);
                        validateExcelData(newData); // 验证数据有效性
                        
                        currentContent = data.content;
                        const wasRenaming = isRenamingColumn;
                        isRenamingColumn = false;
                        updateEditorContent(currentContent);
                        updateEditorsList(data.editors);
                        logActivity(`${data.username} 将${data.oldName}重命名为${data.newName}`);
                        showStatus(`列名已更新`, 'info');
                        
                        if (wasRenaming) {
                            showToast(`列名已更新`, 'success');
                        }
                    } catch (error) {
                        console.error('处理列名更新失败:', error);
                        showStatus('接收列名更新失败', 'error');
                    }
                }
            });
            
            // 操作确认响应
            socket.on('operation_acknowledged', function(data) {
                if (data.operationId === lastOperationId) {
                    pendingSyncs--;
                    if (pendingSyncs <= 0) {
                        pendingSyncs = 0;
                        isSyncing = false;
                    }
                    showStatus(`${data.message}`, 'success');
                    showToast(`${data.message}`, 'success');
                    lastOperationId = null;
                }
            });
            
            // Word结构更新
            socket.on('word_structure_updated', function(data) {
                if (!isSyncing && fileType === 'word') {
                    currentContent = data.content;
                    updateEditorContent(currentContent);
                    updateEditorsList(data.editors);
                    logActivity(`${data.username} ${data.action}`);
                    showStatus(`已接收文档结构更新`, 'info');
                }
            });
            
            // 用户加入/离开事件处理...
            socket.on('user_joined_editor', function(data) {
                updateEditorsList(data.editors);
                logActivity(`${data.username} 加入了编辑`);
                showStatus(`${data.username} 加入了编辑`, 'info');
            });
            
            socket.on('user_left_editor', function(data) {
                updateEditorsList(data.editors);
                logActivity(`${data.username} 离开了编辑`, 'info');
                showStatus(`${data.username} 离开了编辑`, 'info');
            });
            
            // 同步完成确认
            socket.on('sync_complete', function(data) {
                pendingSyncs--;
                if (pendingSyncs <= 0) {
                    pendingSyncs = 0;
                    isSyncing = false;
                }
                showStatus('已同步', 'success');
            });
            
            // 同步错误处理
            socket.on('sync_error', function(error) {
                pendingSyncs--;
                if (pendingSyncs <= 0) {
                    pendingSyncs = 0;
                    isSyncing = false;
                }
                
                if (error.operationId === lastOperationId) {
                    showStatus(`操作失败: ${error.message}`, 'error');
                    showToast(`操作失败: ${error.message}`, 'error');
                    logActivity(`操作失败: ${error.message}`);
                    lastOperationId = null;
                    
                    // 请求最新内容以恢复一致性
                    socket.emit('request_content', fileId);
                } else {
                    showStatus(`同步失败: ${error.message}`, 'error');
                    logActivity(`同步失败: ${error.message}`);
                }
            });
            
            // 在线用户更新
            socket.on('online_users_updated', function(users) {
                updateOnlineUsersList(users);
            });
        }
        
        // 初始化Word编辑器
        function initWordEditor() {
            editorElement = document.getElementById('word-editor');
            
            // 添加输入事件监听，使用防抖函数
            editorElement.addEventListener('input', debounce(function() {
                updateWordEditPosition();
                saveChanges();
            }, 300));
        }
        
        // 初始化Word事件监听器
        function initWordEventListeners() {
            document.getElementById('add-paragraph-btn').addEventListener('click', addParagraph);
            editorElement.addEventListener('click', updateWordEditPosition);
            editorElement.addEventListener('keyup', updateWordEditPosition);
        }
        
        // 更新Word编辑位置
        function updateWordEditPosition() {
            if (!editorElement || !wordData) return;
            
            const cursorPos = editorElement.selectionStart;
            const text = editorElement.value;
            
            let paragraphCount = 1;
            let charCount = 0;
            
            for (let i = 0; i < wordData.length; i++) {
                charCount += wordData[i].text.length + 1;
                if (cursorPos < charCount) {
                    paragraphCount = i + 1;
                    break;
                }
            }
            
            document.getElementById('edit-position').value = `段落 ${paragraphCount}`;
        }
        
        // 添加段落
        function addParagraph() {
            if (!wordData || isSyncing) return;
            
            const cursorPos = editorElement.selectionStart;
            const text = editorElement.value;
            const paragraphs = text.split('\n');
            
            let insertIndex = paragraphs.length;
            let charCount = 0;
            
            for (let i = 0; i < paragraphs.length; i++) {
                charCount += paragraphs[i].length + 1;
                if (cursorPos < charCount) {
                    insertIndex = i + 1;
                    break;
                }
            }
            
            wordData.splice(insertIndex, 0, { text: '' });
            editorElement.value = wordData.map(p => p.text).join('\n');
            
            currentContent = JSON.stringify(wordData);
            saveWordStructureChange(`添加了段落 ${insertIndex + 1}`);
        }
        
        // 保存Word结构更改
        function saveWordStructureChange(action) {
            if (!currentContent) return;
            
            isSyncing = true;
            pendingSyncs++;
            showStatus(`正在同步${action}...`, 'pending');
            
            socket.emit('word_structure_change', {
                file_id: fileId,
                content: currentContent,
                action: action,
                position: document.getElementById('edit-position').value || '文档结构'
            });
            
            logActivity(`你${action}`);
        }
        
        // 初始化Excel编辑器
        function initExcelEditor() {
            // 初始化默认Excel数据结构
            excelData = {
                columns: ['列 1', '列 2', '列 3'],
                data: [
                    ['', '', ''],
                    ['', '', ''],
                    ['', '', '']
                ]
            };
            currentContent = JSON.stringify(excelData);
            renderExcelTable(excelData);
        }
        
        // 初始化Excel事件监听器
        function initExcelEventListeners() {
            document.getElementById('add-row-btn').addEventListener('click', debounce(addRow, 500));
            document.getElementById('delete-row-btn').addEventListener('click', debounce(deleteRow, 500));
            document.getElementById('add-col-btn').addEventListener('click', debounce(addColumn, 500));
            document.getElementById('delete-col-btn').addEventListener('click', debounce(deleteColumn, 500));
        }
        
        // 初始化行列拉伸功能
        function initResizeHandlers() {
            let resizing = false;
            let currentCol = -1;
            let currentRow = -1;
            let startX, startY, startWidth, startHeight;
            
            document.addEventListener('mousedown', function(e) {
                if (e.target.classList.contains('column-resizer')) {
                    resizing = true;
                    currentCol = parseInt(e.target.parentElement.dataset.index);
                    startX = e.pageX;
                    startWidth = e.target.parentElement.offsetWidth;
                    
                    document.body.classList.add('resizing');
                    e.preventDefault();
                } else if (e.target.classList.contains('row-resizer')) {
                    resizing = true;
                    currentRow = parseInt(e.target.parentElement.dataset.row);
                    startY = e.pageY;
                    startHeight = e.target.parentElement.offsetHeight;
                    
                    document.body.classList.add('resizing');
                    e.preventDefault();
                }
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!resizing) return;
                
                if (currentCol !== -1) {
                    const newWidth = startWidth + (e.pageX - startX);
                    if (newWidth >= 50) {
                        columnWidths[currentCol] = newWidth;
                        applyColumnWidth(currentCol);
                    }
                } else if (currentRow !== -1) {
                    const newHeight = startHeight + (e.pageY - startY);
                    if (newHeight >= 30) {
                        rowHeights[currentRow] = newHeight;
                        applyRowHeight(currentRow);
                    }
                }
                
                e.preventDefault();
            });
            
            document.addEventListener('mouseup', function(e) {
                if (resizing) {
                    resizing = false;
                    document.body.classList.remove('resizing');
                    
                    if (currentCol !== -1) {
                        const action = `列 ${String.fromCharCode(65 + currentCol)} 宽度`;
                        socket.emit('excel_dimensions_change', {
                            file_id: fileId,
                            columnWidths: { [currentCol]: columnWidths[currentCol] },
                            action: `调整了${action}`
                        });
                        logActivity(`你调整了${action}`);
                        currentCol = -1;
                    } else if (currentRow !== -1) {
                        const action = `行 ${currentRow + 1} 高度`;
                        socket.emit('excel_dimensions_change', {
                            file_id: fileId,
                            rowHeights: { [currentRow]: rowHeights[currentRow] },
                            action: `调整了${action}`
                        });
                        logActivity(`你调整了${action}`);
                        currentRow = -1;
                    }
                }
            });
        }
        
        // 应用所有列宽和行高设置
        function applyDimensions() {
            Object.keys(columnWidths).forEach(colIndex => {
                applyColumnWidth(parseInt(colIndex));
            });
            
            Object.keys(rowHeights).forEach(rowIndex => {
                applyRowHeight(parseInt(rowIndex));
            });
        }
        
        // 应用指定列的宽度
        function applyColumnWidth(colIndex) {
            const width = columnWidths[colIndex];
            if (!width) return;
            
            const headerCells = document.querySelectorAll('.excel-header-cell');
            if (headerCells[colIndex]) {
                headerCells[colIndex].style.width = `${width}px`;
                headerCells[colIndex].style.minWidth = `${width}px`;
            }
            
            document.querySelectorAll(`input[data-col="${colIndex}"]`).forEach(input => {
                input.style.width = `${width - 10}px`;
            });
        }
        
        // 应用指定行的高度
        function applyRowHeight(rowIndex) {
            const height = rowHeights[rowIndex];
            if (!height) return;
            
            const rowNumberCells = document.querySelectorAll('.excel-row-number');
            if (rowNumberCells[rowIndex + 1]) {
                rowNumberCells[rowIndex + 1].style.height = `${height}px`;
                rowNumberCells[rowIndex + 1].style.minHeight = `${height}px`;
            }
            
            const rowElement = document.querySelector(`tr[data-row="${rowIndex}"]`);
            if (rowElement) {
                rowElement.querySelectorAll('input').forEach(input => {
                    input.style.height = `${height - 10}px`;
                    input.style.minHeight = `${height - 10}px`;
                });
            }
        }
        
        // 加载在线用户
        function loadOnlineUsers() {
            $.get('/online-users', function(data) {
                updateOnlineUsersList(data);
            });
        }
        
        // 更新在线用户列表
        function updateOnlineUsersList(users) {
            const usersList = document.getElementById('online-users-list');
            usersList.innerHTML = '';
            
            users.forEach(function(user) {
                const isCurrentUser = user === username;
                usersList.innerHTML += `
                    <div class="d-flex align-items-center mb-2 ${isCurrentUser ? 'text-primary' : ''}">
                        <span class="badge bg-success me-2">●</span>
                        <span>${user} ${isCurrentUser ? '(你)' : ''}</span>
                    </div>
                `;
            });
        }
        
        // 更新编辑器内容
        function updateEditorContent(content) {
            if (fileType === 'word') {
                try {
                    wordData = JSON.parse(content);
                    editorElement.value = wordData.map(p => p.text).join('\n');
                    updateWordEditPosition();
                } catch (e) {
                    console.error('解析Word内容失败:', e);
                    editorElement.value = content;
                    showStatus('解析内容失败', 'error');
                }
            } else if (fileType === 'excel') {
                try {
                    const parsedData = JSON.parse(content);
                    // 验证并修复数据
                    fixExcelData(parsedData);
                    validateExcelData(parsedData);
                    
                    excelData = parsedData;
                    renderExcelTable(excelData);
                    applyDimensions();
                } catch (e) {
                    console.error('解析Excel内容失败:', e);
                    showStatus('解析表格内容失败，已尝试修复', 'error');
                    logActivity(`数据解析错误: ${e.message}`);
                    
                    // 尝试使用最后有效的数据
                    if (excelData) {
                        renderExcelTable(excelData);
                    } else {
                        // 完全失败时初始化默认数据
                        initExcelEditor();
                    }
                }
            }
        }
        
        // 渲染Excel表格
        function renderExcelTable(data) {
            const table = document.getElementById('excel-editor');
            const headerRow = table.querySelector('thead tr');
            const body = document.getElementById('excel-body');
            
            // 清空现有内容（保留行号列）
            while (headerRow.children.length > 1) {
                headerRow.removeChild(headerRow.lastChild);
            }
            body.innerHTML = '';
            
            // 重置选中状态
            selectedRow = -1;
            selectedCol = -1;
            document.getElementById('delete-row-btn').disabled = true;
            document.getElementById('delete-col-btn').disabled = true;
            
            // 创建表头
            data.columns.forEach((col, index) => {
                const th = document.createElement('th');
                th.dataset.index = index;
                th.className = 'excel-header-cell';
                
                const headerInput = document.createElement('input');
                headerInput.type = 'text';
                headerInput.className = 'excel-header-input';
                headerInput.value = col;
                headerInput.dataset.col = index;
                
                headerInput.addEventListener('focus', function() {
                    isRenamingColumn = true;
                    this.select();
                });
                
                headerInput.addEventListener('blur', debounce(function() {
                    const newName = this.value.trim() || `列 ${index + 1}`;
                    const oldName = data.columns[index];
                    
                    if (newName !== oldName) {
                        data.columns[index] = newName;
                        currentContent = JSON.stringify(data);
                        saveColumnRename(index, oldName, newName);
                    } else {
                        isRenamingColumn = false;
                    }
                }, 300));
                
                headerInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        this.blur();
                    } else if (e.key === 'Escape') {
                        this.value = data.columns[index];
                        this.blur();
                        isRenamingColumn = false;
                    }
                });
                
                const resizer = document.createElement('div');
                resizer.className = 'column-resizer';
                
                th.appendChild(headerInput);
                th.appendChild(resizer);
                
                th.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('excel-header-input') && 
                        !e.target.classList.contains('column-resizer')) {
                        e.stopPropagation();
                        selectedCol = parseInt(this.dataset.index);
                        selectedRow = -1;
                        
                        document.getElementById('delete-col-btn').disabled = false;
                        document.getElementById('delete-row-btn').disabled = true;
                        document.getElementById('edit-position').value = `列 ${selectedCol + 1}`;
                        
                        highlightSelectedCells();
                    }
                });
                
                th.addEventListener('dblclick', function(e) {
                    if (!e.target.classList.contains('column-resizer')) {
                        headerInput.focus();
                    }
                });
                
                headerRow.appendChild(th);
            });
            
            // 创建表格内容行
            data.data.forEach((row, rowIndex) => {
                const tr = document.createElement('tr');
                tr.dataset.row = rowIndex;
                
                const rowNumTd = document.createElement('td');
                rowNumTd.className = 'excel-row-number';
                rowNumTd.textContent = rowIndex + 1;
                rowNumTd.dataset.row = rowIndex;
                
                rowNumTd.addEventListener('click', function(e) {
                    e.stopPropagation();
                    selectedRow = parseInt(this.dataset.row);
                    selectedCol = -1;
                    
                    document.getElementById('delete-row-btn').disabled = false;
                    document.getElementById('delete-col-btn').disabled = true;
                    document.getElementById('edit-position').value = `行 ${selectedRow + 1}`;
                    
                    highlightSelectedCells();
                });
                
                tr.appendChild(rowNumTd);
                
                row.forEach((cell, colIndex) => {
                    const td = document.createElement('td');
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'form-control form-control-sm excel-cell';
                    input.value = cell !== null ? cell : '';
                    input.dataset.row = rowIndex;
                    input.dataset.col = colIndex;
                    
                    if (colIndex === 0) {
                        const resizer = document.createElement('div');
                        resizer.className = 'row-resizer';
                        td.appendChild(resizer);
                    }
                    
                    const cellRef = String.fromCharCode(65 + colIndex) + (rowIndex + 1);
                    
                    input.addEventListener('click', function(e) {
                        e.stopPropagation();
                        selectedRow = parseInt(this.dataset.row);
                        selectedCol = parseInt(this.dataset.col);
                        
                        document.getElementById('delete-row-btn').disabled = false;
                        document.getElementById('delete-col-btn').disabled = false;
                        document.getElementById('edit-position').value = cellRef;
                        
                        highlightSelectedCells();
                    });
                    
                    input.addEventListener('change', debounce(function() {
                        if (excelData) {
                            excelData.data[rowIndex][colIndex] = this.value;
                            currentContent = JSON.stringify(excelData);
                            saveChanges(cellRef);
                        }
                    }, 300));
                    
                    td.appendChild(input);
                    tr.appendChild(td);
                });
                
                body.appendChild(tr);
            });
        }
        
        // 保存列名修改
        function saveColumnRename(colIndex, oldName, newName) {
            if (!currentContent || !excelData) {
                isRenamingColumn = false;
                return;
            }
            
            lastOperationId = 'col_rename_' + Date.now();
            
            isSyncing = true;
            pendingSyncs++;
            showStatus(`正在同步列名修改...`, 'pending');
            
            socket.emit('excel_rename_column', {
                file_id: fileId,
                content: currentContent,
                columnIndex: colIndex,
                oldName: oldName,
                newName: newName,
                position: `列 ${colIndex + 1}`,
                columnCount: excelData.columns.length,
                rowCount: excelData.data.length,
                operationId: lastOperationId,
                operationType: 'column_rename'
            });
            
            logActivity(`你将${oldName}重命名为${newName}`);
            
            // 超时处理
            setTimeout(() => {
                if (lastOperationId && pendingSyncs > 0) {
                    showStatus(`列名同步超时`, 'error');
                    showToast(`列名同步超时`, 'error');
                    
                    // 恢复原始列名
                    excelData.columns[colIndex] = oldName;
                    currentContent = JSON.stringify(excelData);
                    updateEditorContent(currentContent);
                    
                    pendingSyncs--;
                    isRenamingColumn = false;
                    lastOperationId = null;
                    if (pendingSyncs <= 0) {
                        pendingSyncs = 0;
                        isSyncing = false;
                    }
                }
            }, 5000);
        }
        
        // 高亮显示选中的行或列
        function highlightSelectedCells() {
            document.querySelectorAll('.selected-row').forEach(el => {
                el.classList.remove('selected-row');
            });
            document.querySelectorAll('.selected-col').forEach(el => {
                el.classList.remove('selected-col');
            });
            
            if (selectedRow !== -1) {
                const rowElement = document.querySelector(`tr[data-row="${selectedRow}"]`);
                if (rowElement) {
                    rowElement.classList.add('selected-row');
                }
            }
            
            if (selectedCol !== -1) {
                document.querySelectorAll(`input[data-col="${selectedCol}"]`).forEach(input => {
                    input.closest('td').classList.add('selected-col');
                });
                const headerCells = document.querySelectorAll('.excel-header-cell');
                if (headerCells[selectedCol]) {
                    headerCells[selectedCol].classList.add('selected-col');
                }
            }
        }
        
        // 添加行
        function addRow() {
            if (!excelData || isSyncing) return;
            
            let insertIndex = selectedRow !== -1 ? selectedRow + 1 : excelData.data.length;
            
            // 创建新行数据（与列数匹配）
            const newRow = Array(excelData.columns.length).fill('');
            
            // 插入新行
            excelData.data.splice(insertIndex, 0, newRow);
            
            // 生成唯一操作ID
            lastOperationId = 'row_add_' + Date.now();
            
            // 保存更改
            currentContent = JSON.stringify(excelData);
            const action = `添加了行 ${insertIndex + 1}`;
            
            isSyncing = true;
            pendingSyncs++;
            showStatus(`正在同步${action}...`, 'pending');
            
            // 发送行添加请求
            socket.emit('excel_structure_change', {
                file_id: fileId,
                content: currentContent,
                action: action,
                position: `行 ${insertIndex + 1}`,
                columnCount: excelData.columns.length,
                rowCount: excelData.data.length,
                operationType: 'row',
                operationId: lastOperationId,
                operation: 'add',
                rowIndex: insertIndex
            });
            
            logActivity(`你${action}`);
            renderExcelTable(excelData);
            applyDimensions();
            
            // 超时处理
            setTimeout(() => {
                if (lastOperationId && pendingSyncs > 0) {
                    showStatus(`行添加同步超时`, 'error');
                    showToast(`行添加同步超时`, 'error');
                    
                    // 撤销操作
                    excelData.data.splice(insertIndex, 1);
                    currentContent = JSON.stringify(excelData);
                    renderExcelTable(excelData);
                    
                    pendingSyncs--;
                    lastOperationId = null;
                    if (pendingSyncs <= 0) {
                        pendingSyncs = 0;
                        isSyncing = false;
                    }
                }
            }, 5000);
        }
        
        // 删除行
        function deleteRow() {
            if (!excelData || selectedRow === -1 || excelData.data.length <= 1 || isSyncing) return;
            
            const deletedRowNumber = selectedRow + 1;
            const deletedRowIndex = selectedRow;
            const deletedRowData = excelData.data[selectedRow];
            
            // 删除选中的行
            excelData.data.splice(selectedRow, 1);
            
            // 生成唯一操作ID
            lastOperationId = 'row_delete_' + Date.now();
            
            // 保存更改
            currentContent = JSON.stringify(excelData);
            const action = `删除了行 ${deletedRowNumber}`;
            
            isSyncing = true;
            pendingSyncs++;
            showStatus(`正在同步${action}...`, 'pending');
            
            // 发送行删除请求
            socket.emit('excel_structure_change', {
                file_id: fileId,
                content: currentContent,
                action: action,
                position: `行 ${deletedRowNumber}`,
                columnCount: excelData.columns.length,
                rowCount: excelData.data.length,
                operationType: 'row',
                operationId: lastOperationId,
                operation: 'delete',
                rowIndex: deletedRowIndex
            });
            
            logActivity(`你${action}`);
            renderExcelTable(excelData);
            applyDimensions();
            
            // 超时处理
            setTimeout(() => {
                if (lastOperationId && pendingSyncs > 0) {
                    showStatus(`行删除同步超时`, 'error');
                    showToast(`行删除同步超时`, 'error');
                    
                    // 恢复删除的行
                    excelData.data.splice(deletedRowIndex, 0, deletedRowData);
                    currentContent = JSON.stringify(excelData);
                    renderExcelTable(excelData);
                    
                    pendingSyncs--;
                    lastOperationId = null;
                    if (pendingSyncs <= 0) {
                        pendingSyncs = 0;
                        isSyncing = false;
                    }
                }
            }, 5000);
        }
        
        // 添加列
        function addColumn() {
            if (!excelData || isSyncing) return;
            
            let insertIndex = selectedCol !== -1 ? selectedCol + 1 : excelData.columns.length;
            const newColName = `列 ${insertIndex + 1}`;
            
            // 添加新列标题
            excelData.columns.splice(insertIndex, 0, newColName);
            
            // 为每一行添加新单元格
            excelData.data.forEach(row => {
                row.splice(insertIndex, 0, '');
            });
            
            lastOperationId = 'col_add_' + Date.now();
            currentContent = JSON.stringify(excelData);
            const action = `添加了列 ${insertIndex + 1}`;
            
            isSyncing = true;
            pendingSyncs++;
            showStatus(`正在同步${action}...`, 'pending');
            
            socket.emit('excel_structure_change', {
                file_id: fileId,
                content: currentContent,
                action: action,
                position: `列 ${insertIndex + 1}`,
                columnCount: excelData.columns.length,
                rowCount: excelData.data.length,
                operationType: 'column',
                operationId: lastOperationId,
                operation: 'add',
                columnIndex: insertIndex
            });
            
            logActivity(`你${action}`);
            renderExcelTable(excelData);
            applyDimensions();
        }
        
        // 删除列
        function deleteColumn() {
            if (!excelData || selectedCol === -1 || excelData.columns.length <= 1 || isSyncing) return;
            
            const deletedColNumber = selectedCol + 1;
            const deletedColName = excelData.columns[selectedCol];
            const deletedColIndex = selectedCol;
            
            // 删除列标题
            excelData.columns.splice(selectedCol, 1);
            
            // 从每一行删除对应单元格
            excelData.data.forEach(row => {
                row.splice(selectedCol, 1);
            });
            
            lastOperationId = 'col_delete_' + Date.now();
            currentContent = JSON.stringify(excelData);
            const action = `删除了列 ${deletedColNumber} (${deletedColName})`;
            
            isSyncing = true;
            pendingSyncs++;
            showStatus(`正在同步${action}...`, 'pending');
            
            socket.emit('excel_structure_change', {
                file_id: fileId,
                content: currentContent,
                action: action,
                position: `列 ${deletedColNumber}`,
                columnCount: excelData.columns.length,
                rowCount: excelData.data.length,
                operationType: 'column',
                operationId: lastOperationId,
                operation: 'delete',
                columnIndex: deletedColIndex
            });
            
            logActivity(`你${action}`);
            renderExcelTable(excelData);
            applyDimensions();
        }
        
        // 保存更改并广播
        function saveChanges(position) {
            if (!currentContent || isSyncing) return;
            
            const editPosition = position || document.getElementById('edit-position').value;
            
            if (fileType === 'word' && editorElement) {
                const text = editorElement.value;
                const paragraphs = text.split('\n').map(text => ({ text: text }));
                currentContent = JSON.stringify(paragraphs);
                wordData = paragraphs;
            }
            
            isSyncing = true;
            pendingSyncs++;
            showStatus('正在同步...', 'pending');
            
            socket.emit('editor_action', {
                file_id: fileId,
                content: currentContent,
                position: editPosition || '未指定位置'
            });
        }
        
        // 更新编辑者列表
        function updateEditorsList(editors) {
            const editorsList = document.getElementById('editors-list');
            editorsList.innerHTML = '';
            
            if (typeof editors !== 'object' || editors === null || Array.isArray(editors)) {
                editors = {};
            }
            
            for (const [user, position] of Object.entries(editors)) {
                const isCurrentUser = user === username;
                
                const item = document.createElement('div');
                item.className = `mb-2 ${isCurrentUser ? 'text-primary' : ''}`;
                
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>${user} ${isCurrentUser ? '(你)' : ''}</strong>
                        <small class="text-muted">${position}</small>
                    </div>
                `;
                
                editorsList.appendChild(item);
            }
        }
        
        // 显示状态信息
        function showStatus(message, type = 'success') {
            const indicator = document.getElementById('status-indicator');
            const syncDot = indicator.querySelector('.sync-indicator');
            const textSpan = indicator.querySelector('span:not(.sync-indicator)');
            
            syncDot.className = 'sync-indicator';
            if (type === 'pending') {
                syncDot.classList.add('sync-pending');
            } else if (type === 'success') {
                syncDot.classList.add('sync-complete');
            } else if (type === 'warning') {
                syncDot.classList.add('sync-pending');
            } else if (type === 'error') {
                syncDot.classList.add('sync-error');
            }
            
            textSpan.textContent = message;
            
            indicator.className = '';
            if (type === 'success') {
                indicator.classList.add('text-success');
            } else if (type === 'info') {
                indicator.classList.add('text-info');
            } else if (type === 'warning') {
                indicator.classList.add('text-warning');
            } else if (type === 'error') {
                indicator.classList.add('text-danger');
            }
        }
        
        // 记录操作日志
        function logActivity(message) {
            const logContainer = document.getElementById('activity-log');
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            
            const logItem = document.createElement('div');
            logItem.className = 'mb-1';
            logItem.innerHTML = `<small>[${timeString}] ${message}</small>`;
            
            if (logContainer.firstChild) {
                logContainer.insertBefore(logItem, logContainer.firstChild);
            } else {
                logContainer.appendChild(logItem);
            }
            
            if (logContainer.children.length > 10) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }
        
        // 页面关闭时离开编辑房间
        window.addEventListener('beforeunload', function() {
            if (socket) {
                socket.emit('leave_editor', fileId);
            }
        });
    </script>
</body>
</html>
    
